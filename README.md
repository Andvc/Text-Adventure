# ç›®å‰è¿˜åœ¨å¼€å‘é˜¶æ®µï¼Œrunä¸å¾—ï¼Œä»…ä½œè¿›ç¨‹å±•ç¤ºğŸ˜Š

# Text Adventure

åŸºäºPythonçš„æ–‡å­—å†’é™©æ¸¸æˆï¼Œé€šè¿‡AIé©±åŠ¨æ•…äº‹ç”Ÿæˆã€é“å…·è·å–ã€å‰§æƒ…èµ°å‘ã€å‡çº§è¿›é˜¶ã€ç»“å±€å¯¼å‘ã€‚

## é¡¹ç›®ç»“æ„

```
Text Adventure/
â”œâ”€â”€ ai/                # AIæ¨¡å— - æç¤ºè¯å¤„ç†ä¸APIäº¤äº’
â”œâ”€â”€ data/              # æ•°æ®æ¨¡å— - æ¸¸æˆæ•°æ®ç®¡ç†
â”‚   â””â”€â”€ text/          # æ–‡æœ¬æ•°æ®æ–‡ä»¶
â”‚       â””â”€â”€ power_levels.json  # èƒ½åŠ›ç­‰çº§æ•°æ®
â”œâ”€â”€ gameflow/          # æ¸¸æˆæµç¨‹æ¨¡å— - æ¸¸æˆæµç¨‹æ§åˆ¶å’Œç®¡ç†
â”‚   â”œâ”€â”€ background_creation.py  # èƒŒæ™¯åˆ›å»ºç®¡ç†å™¨
â”‚   â”œâ”€â”€ power_generator.py      # èƒ½åŠ›ä¸ç‰©å“ç”Ÿæˆå™¨
â”‚   â”œâ”€â”€ event_selector.py       # äº‹ä»¶é€‰æ‹©å™¨
â”‚   â””â”€â”€ README.md              # æ¸¸æˆæµç¨‹æ¨¡å—è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ storyline/         # æ•…äº‹çº¿æ¨¡å— - æ•…äº‹æ¨¡æ¿ä¸å‰§æƒ…ç”Ÿæˆ
â”‚   â”œâ”€â”€ templates/     # æ¨¡æ¿æ–‡ä»¶ç›®å½•
â”‚   â”‚   â”œâ”€â”€ example.json                # ç¤ºä¾‹æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ simple_loop.json            # ç®€å•å¾ªç¯æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ power_item_generator.json   # èƒ½åŠ›ç‰©å“ç”Ÿæˆæ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ era_background_generator.json   # æ—¶ä»£èƒŒæ™¯ç”Ÿæˆæ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ family_background_generator.json # å®¶åº­èƒŒæ™¯ç”Ÿæˆæ¨¡æ¿
â”‚   â”‚   â””â”€â”€ event_system.json           # äº‹ä»¶ç³»ç»Ÿæ¨¡æ¿
â”‚   â””â”€â”€ storyline_manager.py  # æ•…äº‹çº¿ç®¡ç†å™¨
â”œâ”€â”€ save/              # æ¸¸æˆå­˜æ¡£ç›®å½•
â”œâ”€â”€ test/              # æµ‹è¯•æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ test_example.py            # ç¤ºä¾‹æµ‹è¯•
â”‚   â”œâ”€â”€ test_simple_loop_cycle.py  # å¾ªç¯æµ‹è¯•
â”‚   â”œâ”€â”€ test_save_system.py        # å­˜æ¡£ç³»ç»Ÿæµ‹è¯•
â”‚   â”œâ”€â”€ test_power_item_generator.py # èƒ½åŠ›ç”Ÿæˆæµ‹è¯•
â”‚   â””â”€â”€ test_event_system.py       # äº‹ä»¶ç³»ç»Ÿæµ‹è¯•
â”œâ”€â”€ editor/            # JSONç¼–è¾‘å™¨ - é…ç½®æ–‡ä»¶å¯è§†åŒ–ç¼–è¾‘å·¥å…·ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ game_main.py       # æ¸¸æˆä¸»ç¨‹åº
â””â”€â”€ config.py          # å…¨å±€é…ç½®æ–‡ä»¶
```

## åŠŸèƒ½æ¼”ç¤º

### 1. åµŒå¥—å ä½ç¬¦ç³»ç»Ÿ

åµŒå¥—å ä½ç¬¦å…è®¸åœ¨å ä½ç¬¦å†…éƒ¨åµŒå…¥å…¶ä»–å ä½ç¬¦ï¼Œå®ç°åŠ¨æ€å¼•ç”¨ï¼š

```json
// å­˜æ¡£æ•°æ®
{
  "active_field": "name",
  "character": {
    "name": "æç™½",
    "title": "è¯—ä»™"
  },
  "skill_index": 2,
  "skills": ["å‰‘æ³•", "é£è¡Œ", "é¥®é…’"]
}

// ä½¿ç”¨åµŒå¥—å ä½ç¬¦çš„æ¨¡æ¿
"prompt_segments": [
  "(è§’è‰²å±æ€§: {character.{active_field}})",  // ç»“æœ: (è§’è‰²å±æ€§: æç™½)
  "(é€‰ä¸­æŠ€èƒ½: {skills[{skill_index}]})",  // ç»“æœ: (é€‰ä¸­æŠ€èƒ½: é¥®é…’)
  "<æ ¹æ®è§’è‰²å±æ€§å’ŒæŠ€èƒ½ç”Ÿæˆæè¿°>"
]
```

åµŒå¥—å ä½ç¬¦ä½¿æ¨¡æ¿æ›´å…·çµæ´»æ€§ï¼Œå¯ä»¥æ ¹æ®æ¸¸æˆçŠ¶æ€åŠ¨æ€é€‰æ‹©è¦æ˜¾ç¤ºçš„æ•°æ®ã€‚

### 2. æ–‡æœ¬æ•°æ®å¼•ç”¨

å¯ä»¥ç›´æ¥ä»`data/text`ç›®å½•ä¸‹çš„JSONæ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼š

```json
// data/text/eras.json
{
  "eras": [
    {
      "id": "builders_era",
      "name": "å»ºæ„è€…æ–‡æ˜",
      "era_number": 1,
      "key_features": ["æœ€æ—©æŒæ¡ç»´åº¦å·¥ç¨‹", "å»ºé€ äº†è¿æ¥å„ç•Œçš„é­”æ³•é€šé“"]
    },
    {
      "id": "star_spirit_era",
      "name": "æ˜Ÿçµæ–‡æ˜",
      "era_number": 2,
      "key_features": ["å°†åŸèƒ½å‡èšæˆæ°¸æ’æ˜Ÿä½“", "åˆ›é€ äº†'é­”æ³•å¤©ç©¹ç³»ç»Ÿ'"]
    }
  ]
}

// ä½¿ç”¨æ–‡æœ¬æ•°æ®å¼•ç”¨çš„æ¨¡æ¿
"prompt_segments": [
  "(å½“å‰çºªå…ƒ: {text;eras;eras[0].name})",  // ç»“æœ: (å½“å‰çºªå…ƒ: å»ºæ„è€…æ–‡æ˜)
  "(çºªå…ƒç¼–å·: ç¬¬{text;eras;eras[0].era_number}çºªå…ƒ)",  // ç»“æœ: (çºªå…ƒç¼–å·: ç¬¬1çºªå…ƒ)
  "(ä¸‹ä¸€ä¸ªçºªå…ƒ: {text;eras;eras[1].name})",  // ç»“æœ: (ä¸‹ä¸€ä¸ªçºªå…ƒ: æ˜Ÿçµæ–‡æ˜)
  "<åŸºäºçºªå…ƒèƒŒæ™¯ç”Ÿæˆæ•…äº‹>"
]
```

è¿™å…è®¸å°†æ¸¸æˆä¸–ç•Œè®¾å®šã€ç‰©å“æ•°æ®ç­‰åˆ†ç¦»åˆ°ä¸“é—¨çš„æ•°æ®æ–‡ä»¶ä¸­ï¼Œä½¿æ¨¡æ¿æ›´åŠ æ¸…æ™°å’Œå¯ç»´æŠ¤ã€‚

### 3. åŠ¨æ€ç´¢å¼•ä¸æ•°ç»„å¤„ç†

ç³»ç»Ÿæ”¯æŒçµæ´»çš„æ•°ç»„å¤„ç†å’Œå˜é‡ç´¢å¼•ï¼š

```json
// å­˜æ¡£æ•°æ®
{
  "current_era_index": 1,
  "player_choice": 2,
  "available_actions": ["æ¢ç´¢", "å¯¹è¯", "æˆ˜æ–—", "ä¼‘æ¯"]
}

// ä½¿ç”¨åŠ¨æ€ç´¢å¼•çš„æ¨¡æ¿
"prompt_segments": [
  "(å½“å‰çºªå…ƒ: {text;eras;eras[{current_era_index}].name})",  // åŠ¨æ€é€‰æ‹©çºªå…ƒ
  "(ç©å®¶é€‰æ‹©çš„è¡ŒåŠ¨: {available_actions[{player_choice}]})",  // ç»“æœ: (ç©å®¶é€‰æ‹©çš„è¡ŒåŠ¨: æˆ˜æ–—)
  "(æ‰€æœ‰å¯ç”¨è¡ŒåŠ¨: {available_actions})",  // è¿”å›æ•´ä¸ªæ•°ç»„
  "<æ ¹æ®ç©å®¶é€‰æ‹©çš„è¡ŒåŠ¨ç”Ÿæˆäº‹ä»¶>"
]
```

å˜é‡ç´¢å¼•ä½¿æ‚¨å¯ä»¥åŠ¨æ€å¼•ç”¨æ•°ç»„å…ƒç´ ï¼Œå¢å¼ºäº†æ¨¡æ¿çš„çµæ´»æ€§ã€‚

### 4. å®Œæ•´æ¨¡æ¿ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ç»“åˆå¤šä¸ªé«˜çº§åŠŸèƒ½çš„å®Œæ•´æ¨¡æ¿ç¤ºä¾‹ï¼Œå¯åœ¨`storyline/templates/example.json`ä¸­æ‰¾åˆ°ï¼š

```json
{
  "template_id": "example",
  "name": "é«˜çº§åŠŸèƒ½æ¼”ç¤ºæ¨¡æ¿",
  "description": "å±•ç¤ºåµŒå¥—å ä½ç¬¦ç³»ç»Ÿã€æ–‡æœ¬æ•°æ®å¼•ç”¨å’Œæ•°ç»„å¤„ç†åŠŸèƒ½",
  "version": "1.0",
  "author": "ç³»ç»Ÿ",
  "created_at": "2025-05-08",
  "tags": [
    "ç¤ºä¾‹",
    "åµŒå¥—å ä½ç¬¦",
    "æ–‡æœ¬æ•°æ®å¼•ç”¨",
    "æ•°ç»„å¤„ç†"
  ],
  "prompt_segments": [
    "(è§’è‰²åç§°: {character.name})",
    "(è§’è‰²èº«ä»½: {character.{identity_field}})",
    "(å½“å‰çºªå…ƒ: {text;eras;eras[{current_era_index}].name})",
    "(çºªå…ƒç¼–å·: ç¬¬{text;eras;eras[{current_era_index}].era_number}çºªå…ƒ)",
    "(ä¸»è¦ç‰¹å¾: {text;eras;eras[{current_era_index}].key_features[0]}, {text;eras;eras[{current_era_index}].key_features[1]})",
    "(å½“å‰åœ°ç‚¹: {location})",
    "(å¯ç”¨æŠ€èƒ½: {skills})",
    "(é€‰ä¸­æŠ€èƒ½: {skills[{active_skill_index}]})",
    "(èƒ½åŠ›ç­‰çº§: {text;power_levels;levels[{power_level}].name})",
    "(èƒ½åŠ›æè¿°: {text;power_levels;levels[{power_level}].universal_description})",
    "<ç”Ÿæˆè§’è‰²èƒŒæ™¯æ•…äº‹>",
    "[character_background=\"string\"]",
    "<ç”Ÿæˆå½“å‰åœºæ™¯æè¿°>",
    "[current_scene=\"string\"]",
    "<ç”Ÿæˆä¸‰ä¸ªé€‰é¡¹>",
    "[option1=\"string\", option2=\"string\", option3=\"string\"]"
  ],
  "output_storage": {
    "character_background": "character_background",
    "current_scene": "current_scene",
    "option1": "option1",
    "option2": "option2",
    "option3": "option3"
  },
  "prompt_template": "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„è§’è‰²èƒŒæ™¯ä¸åœºæ™¯è®¾è®¡å¸ˆï¼Œæ“…é•¿åˆ›å»ºç¬¦åˆä¸–ç•Œè§‚è®¾å®šçš„å†…å®¹ã€‚è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ï¼Œåˆ›å»ºå¼•äººå…¥èƒœçš„è§’è‰²èƒŒæ™¯å’Œåœºæ™¯ã€‚\n\n## èƒŒæ™¯ä¿¡æ¯\n{input_info}\n\n## è¾“å‡ºæ ¼å¼\nè¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼å›å¤ï¼Œæ³¨æ„ä¸‰å¼•å·ä¸­çš„å†…å®¹æ˜¯æŒ‡ä»¤ï¼Œä½ éœ€è¦æ ¹æ®æŒ‡ä»¤ç”Ÿæˆå†…å®¹ï¼š\n{format}"
}
```

è¿™ä¸ªæ¨¡æ¿ä½¿ç”¨äº†å¤šç§é«˜çº§åŠŸèƒ½ï¼š
- åµŒå¥—å ä½ç¬¦ï¼š`{character.{identity_field}}`
- æ–‡æœ¬æ•°æ®å¼•ç”¨ï¼š`{text;eras;eras[{current_era_index}].name}`
- åŠ¨æ€æ•°ç»„ç´¢å¼•ï¼š`{skills[{active_skill_index}]}`
- å®Œæ•´æ•°ç»„å¼•ç”¨ï¼š`{skills}`

å¹¶ä¸”åŒ…å«äº†å®Œæ•´çš„`prompt_template`ï¼Œå®šä¹‰äº†AIç”Ÿæˆå†…å®¹çš„æŒ‡ä»¤å’Œæ ¼å¼ã€‚

### 5. åŠ¨æ€æ•…äº‹ç”Ÿæˆæµç¨‹

ä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´çš„åŠ¨æ€æ•…äº‹ç”Ÿæˆæµç¨‹ç¤ºä¾‹ï¼Œå¯é€šè¿‡è¿è¡Œ`test/test_example.py`æµ‹è¯•ï¼š

```python
# åˆå§‹åŒ–æ•…äº‹çº¿ç®¡ç†å™¨
manager = StorylineManager()

# åŠ è½½æˆ–åˆ›å»ºå­˜æ¡£
save_name = "example"
current_save = {
    "id": save_name,
    "character": {
        "name": "è‰¾é‡Œå…‹",
        "profession": "å­¦è€…"
    },
    "identity_field": "profession",
    "current_era_index": 4,  # å¯¹åº”ä¸‡è±¡å¸å›½
    "location": "é­”æ³•å­¦é™¢å›¾ä¹¦é¦†",
    "skills": ["ç«çƒæœ¯", "é­”æ³•æŠ¤ç›¾", "å…‰ç…§æœ¯", "å…ƒç´ æ„ŸçŸ¥", "é­”æ³•è§£æ"],
    "active_skill_index": 2,
    "power_level": 3
}

# ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆæ•…äº‹ï¼ˆæ¨¡æ¿ä½¿ç”¨åµŒå¥—å ä½ç¬¦å’Œæ–‡æœ¬æ•°æ®å¼•ç”¨ï¼‰
success = manager.generate_story(save_name, "example")

if success:
    # è·å–ç”Ÿæˆçš„å†…å®¹
    updated_save = load_save("character", save_name)
    
    # æ˜¾ç¤ºæ–°çš„æ•…äº‹å†…å®¹
    print(f"è§’è‰²èƒŒæ™¯: {updated_save['character_background']}")
    print(f"å½“å‰åœºæ™¯: {updated_save['current_scene']}")
    
    # æ˜¾ç¤ºå¯ç”¨é€‰é¡¹
    for i, option in enumerate([updated_save['option1'], updated_save['option2'], updated_save['option3']], 1):
        print(f"é€‰é¡¹{i}: {option}")
```

## æ¨¡å—åŠŸèƒ½ä»‹ç»

### æ•°æ®æ¨¡å— (data/)
- ç®¡ç†æ¸¸æˆçŠ¶æ€å’Œå­˜æ¡£æ•°æ®
- æä¾›ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£
- å¤„ç†æ•°æ®æŒä¹…åŒ–
- æ”¯æŒåµŒå¥—æ•°æ®ç»“æ„å’Œæ•°ç»„
- æä¾›æ–‡æœ¬æ•°æ®æ–‡ä»¶è®¿é—®åŠŸèƒ½

### æ•…äº‹çº¿æ¨¡å— (storyline/)
- å®šä¹‰å’Œç®¡ç†æ•…äº‹æ¨¡æ¿
- å¤„ç†æç¤ºç‰‡æ®µå’Œè¾“å‡ºæ ¼å¼
- æ”¯æŒåµŒå¥—å ä½ç¬¦å’Œæ–‡æœ¬æ•°æ®å¼•ç”¨
- ç®¡ç†å­˜å‚¨æ˜ å°„
- ç”Ÿæˆæ•…äº‹å†…å®¹

### æ¸¸æˆæµç¨‹æ¨¡å— (gameflow/)
- ç®¡ç†æ¸¸æˆæµç¨‹å’ŒçŠ¶æ€å˜åŒ–
- æä¾›èƒŒæ™¯åˆ›å»ºåŠŸèƒ½ï¼ˆæ—¶ä»£èƒŒæ™¯ã€å®¶åº­èƒŒæ™¯ï¼‰
- å®ç°èƒ½åŠ›ä¸ç‰©å“ç”Ÿæˆï¼ˆæ­¦å™¨ã€èŒä¸šã€æ³•å™¨ç­‰ï¼‰
- æä¾›åŸºäºå¹´é¾„æƒé‡çš„äº‹ä»¶é€‰æ‹©ç³»ç»Ÿ
- å¤„ç†äº‹ä»¶é€‰é¡¹å’Œç»“æœå½±å“

### AIæ¨¡å— (ai/)
- å¤„ç†æç¤ºè¯æ„å»º
- æ”¯æŒå¤æ‚å ä½ç¬¦è§£æ
- ç®¡ç†AI APIè°ƒç”¨
- è§£æAIå“åº”
- æä¾›é”™è¯¯å¤„ç†

## å¿«é€Ÿå¼€å§‹

1. å®‰è£…ä¾èµ–
```bash
pip install -r requirements.txt
```

2. é…ç½®APIå¯†é’¥
```bash
echo "DEEPSEEK_API_KEY=your_api_key" > .env
```

3. è¿è¡Œç¤ºä¾‹æ¼”ç¤º
```bash
python test/test_example.py
```

4. ä½¿ç”¨JSONç¼–è¾‘å™¨ï¼ˆå¯é€‰ï¼‰
```bash
python3 -m editor
```

## æœ€ä½³å®è·µ

1. **æ•°æ®ç®¡ç†**
   - ä½¿ç”¨æœ‰æ„ä¹‰çš„å­—æ®µå
   - å°†å…±äº«æ•°æ®å­˜å‚¨åœ¨data/textç›®å½•ä¸‹
   - ä¿æŒæ•°æ®ç»“æ„çš„ä¸€è‡´æ€§
   - åŠæ—¶ä¿å­˜æ›´æ–°

2. **æ¨¡æ¿è®¾è®¡**
   - ä½¿ç”¨æ¸…æ™°çš„æ ‡é¢˜å’Œåˆ†ç»„
   - åˆ©ç”¨åµŒå¥—å ä½ç¬¦å®ç°åŠ¨æ€å†…å®¹
   - å……åˆ†åˆ©ç”¨æ–‡æœ¬æ•°æ®å¼•ç”¨å‡å°‘é‡å¤
   - æä¾›è¯¦ç»†çš„èƒŒæ™¯ä¿¡æ¯
   - æ˜ç¡®æŒ‡å®šè¾“å‡ºæ ¼å¼

3. **äº‹ä»¶ç³»ç»Ÿ**
   - ä¸ºä¸åŒå¹´é¾„æ®µè®¾ç½®åˆç†çš„æƒé‡
   - æ·»åŠ è¶³å¤Ÿçš„äº‹ä»¶æ¡ä»¶ç¡®ä¿äº‹ä»¶è§¦å‘çš„åˆç†æ€§
   - è®¾è®¡å¤šæ ·çš„äº‹ä»¶é€‰é¡¹åŠç»“æœ
   - ç¡®ä¿äº‹ä»¶é—´çš„è¿è´¯æ€§å’Œæ•…äº‹æµç•…æ€§
   - ç»“åˆè§’è‰²å±æ€§è®¾è®¡äº‹ä»¶æ•ˆæœ

4. **å ä½ç¬¦ä½¿ç”¨**
   - åµŒå¥—å ä½ç¬¦: `{character.{field_name}}` 
   - æ–‡æœ¬æ•°æ®å¼•ç”¨: `{text;file_name;path}`
   - åŠ¨æ€æ•°ç»„ç´¢å¼•: `{array[{index}]}`
   - å®Œæ•´æ•°ç»„å¼•ç”¨: `{array}`

## æ³¨æ„äº‹é¡¹

1. ç¡®ä¿æ‰€æœ‰å ä½ç¬¦å­˜åœ¨äºå­˜æ¡£æ•°æ®æˆ–æ–‡æœ¬æ•°æ®æ–‡ä»¶ä¸­
2. å­˜å‚¨æ˜ å°„çš„å­—æ®µå¿…é¡»ä¸è¾“å‡ºæ ¼å¼åŒ¹é…
3. é¿å…è¿‡æ·±çš„åµŒå¥—ï¼Œä»¥ä¿æŒæ¨¡æ¿çš„å¯è¯»æ€§
4. ç”Ÿæˆå¤±è´¥æ—¶ä¼šè¿”å›Falseï¼Œéœ€è¦æ£€æŸ¥é”™è¯¯ä¿¡æ¯
5. å»ºè®®åœ¨ç”Ÿæˆå‰å¤‡ä»½å­˜æ¡£æ•°æ®
6. äº‹ä»¶è§¦å‘æ¡ä»¶åº”åˆç†è®¾ç½®ï¼Œé¿å…æ— æ³•è§¦å‘çš„æƒ…å†µ 